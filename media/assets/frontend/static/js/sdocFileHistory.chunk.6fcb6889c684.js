(this["webpackJsonpseahub-frontend"]=this["webpackJsonpseahub-frontend"]||[]).push([[17],{1703:function(e,t,n){n(75),e.exports=n(1828)},1723:function(e,t,n){},1724:function(e,t,n){},1725:function(e,t,n){},1726:function(e,t,n){},1828:function(e,t,n){"use strict";n.r(t);var s=n(3),i=n(4),a=n(6),c=n(7),r=n(2),o=n.n(r),l=n(35),d=n.n(l),h=n(1852),u=n(36),f=n.n(u),j=n(21),b=n(22),m=n(28),O=n(29),v=n(145),p=n(248);var g=function(e){var t=e.document;return o.a.createElement(v.c,{document:t||Object(p.a)()})},x=n(26),y=n(123),C=n(104),E=n(285),w=n(45),S=n(25),N=function(){function e(){Object(j.a)(this,e)}return Object(b.a)(e,null,[{key:"getDataType",value:function(e){var t=typeof e;return"object"!==t?t:Object.prototype.toString.call(e).replace(/^\[object (\S+)\]$/,"$1")}},{key:"iterable",value:function(e){return["Object","Array"].includes(this.getDataType(e))}},{key:"isObjectChanged",value:function(e,t,n){var s=this;if(!this.iterable(e))throw new Error("source should be a Object or Array , but got ".concat(this.getDataType(e)));if(this.getDataType(e)!==this.getDataType(t))return!0;var i=Object.keys(e),a=Object.keys(Object(x.a)(Object(x.a)({},e),t)).filter((function(e){return!n.includes(e)}));return i.length!==a.length||a.some((function(i){return s.iterable(e[i])?s.isObjectChanged(e[i],t[i],n):e[i]!==t[i]}))}},{key:"isSameObject",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return!(!e||!t)&&!this.isObjectChanged(e,t,n)}}]),e}(),I=N,D=function(e,t){return e.findIndex((function(e){return e.id===t.id}))},V=function(e,t,n){if(e&&t&&n)if(I.isSameObject(t,n))e.value.push(Object(x.a)(Object(x.a)({},t),{},{diff_type:S.g.COMMON}));else{var s=t.type;if(s!==n.type)return e.changes.push(n.id),e.value.push(Object(x.a)(Object(x.a)({},n),{},{diff_type:S.g.DELETE})),void e.value.push(Object(x.a)(Object(x.a)({},t),{},{diff_type:S.g.ADD}));switch(s){case S.h.PARAGRAPH:case S.h.HEADER1:case S.h.HEADER2:case S.h.HEADER3:case S.h.HEADER4:case S.h.HEADER5:case S.h.HEADER6:case S.h.BLOCKQUOTE:case S.h.LINK:case S.h.CHECK_LIST_ITEM:case S.h.CODE_BLOCK:case S.h.IMAGE:e.changes.push(n.id),e.value.push(Object(x.a)(Object(x.a)({},n),{},{diff_type:S.g.DELETE})),e.value.push(Object(x.a)(Object(x.a)({},t),{},{diff_type:S.g.ADD}));break;case S.h.ORDERED_LIST:case S.h.UNORDERED_LIST:case S.h.LIST_ITEM:case S.h.LIST_LIC:var i,a=M(t.children,n.children),c=a.value,r=a.changes;(i=e.changes).push.apply(i,Object(w.a)(r)),e.value.push(Object(x.a)(Object(x.a)({},t),{},{children:c,diff_type:S.g.MODIFY}));break;default:e.changes.push(n.id),e.value.push(Object(x.a)(Object(x.a)({},n),{},{diff_type:S.g.DELETE})),e.value.push(Object(x.a)(Object(x.a)({},t),{},{diff_type:S.g.ADD}))}}},M=function(e,t){var n={value:[],changes:[]},s={},i={};e.forEach((function(e){s[e.id]=e})),t.forEach((function(e){i[e.id]=e}));for(var a=0;a<e.length;a++){var c=e[a];!i[c.id]?(n.changes.push(c.id),n.value.push(Object(x.a)(Object(x.a)({},c),{},{diff_type:S.g.ADD}))):V(n,c,i[c.id])}return t.forEach((function(e){var i=e.id;if(!s[i]){n.changes.push(i);var a=function(e,t,n){var s=e.value,i=D(s,n);if(i>-1)return i+1;var a=t.length,c=t.findIndex((function(e){return e.id===n})),r=c-1;r=-1===r?0:r;var o=c+1;for(o=o===a-1?a-1:o;-1===i&&r>-2&&o<a+1;){if(r>-1){var l=t[r];if((i=D(s,l))>-1)return i+1}if(o<a){var d=t[o];if((i=D(s,d))>-1)return i}o++,-2===--r&&o<a&&(r=-1),o===a&&r>-1&&(o=a)}return s.length-1}(n,t,i);n.value.splice(a,0,Object(x.a)(Object(x.a)({},e),{},{diff_type:S.g.DELETE}))}})),n},k=n(87),L=(n(1723),function(e){Object(m.a)(n,e);var t=Object(O.a)(n);function n(e){var s;Object(j.a)(this,n),(s=t.call(this,e)).renderLeaf=function(e){return Object(C.d)(e,s.editor)},s.renderElement=function(e){var t=e.element,n=t.diff_type,i=t.type;return n===S.g.ADD?i===S.h.LIST_ITEM?Object(C.c)(Object(x.a)(Object(x.a)({},e),{},{attributes:Object(x.a)(Object(x.a)({},e.attributes),{},{className:"sdoc-diff-added"})}),s.editor):o.a.createElement("div",{className:"sdoc-diff sdoc-diff-added"},Object(C.c)(Object(x.a)(Object(x.a)({},e),{},{attributes:Object(x.a)(Object(x.a)({},e.attributes),{},{className:"sdoc-diff-added"})}),s.editor)):n===S.g.DELETE?i===S.h.LIST_ITEM?Object(C.c)(Object(x.a)(Object(x.a)({},e),{},{attributes:Object(x.a)(Object(x.a)({},e.attributes),{},{className:"sdoc-diff-removed"})}),s.editor):o.a.createElement("div",{className:"sdoc-diff sdoc-diff-removed"},Object(C.c)(Object(x.a)(Object(x.a)({},e),{},{attributes:Object(x.a)(Object(x.a)({},e.attributes),{},{className:"sdoc-diff-removed"})}),s.editor)):n===S.g.MODIFY?i===S.h.ORDERED_LIST||i===S.h.UNORDERED_LIST?Object(C.c)(Object(x.a)(Object(x.a)({},e),{},{attributes:Object(x.a)(Object(x.a)({},e.attributes),{},{className:"sdoc-diff-modify"})}),s.editor):o.a.createElement("div",{className:"sdoc-diff-modify"},Object(C.c)(Object(x.a)(Object(x.a)({},e),{},{attributes:Object(x.a)(Object(x.a)({},e.attributes),{},{className:"sdoc-diff-modify"})}),s.editor)):Object(C.c)(e,s.editor)};var i=e.currentContent,a=e.lastContent;return s.diff=i?function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{children:[]},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{children:[]},n=e.version,s=e.children,i=t.version,a=t.children;return n===i?{value:s,changes:[]}:M(s,a)}(i,a):{value:[],changes:[]},s.editor=Object(E.a)(C.b),k.a.initSettings(),s}return Object(b.a)(n,[{key:"componentDidMount",value:function(){this.props.didMountCallback&&this.props.didMountCallback(this.diff)}},{key:"render",value:function(){return o.a.createElement("div",{className:"sdoc-editor-container"},o.a.createElement("div",{className:"sdoc-editor-content"},o.a.createElement("div",{className:"flex-fill o-auto"},o.a.createElement(y.c,{editor:this.editor,value:this.diff.value,onChange:function(){}},o.a.createElement("div",{className:"article mx-auto"},o.a.createElement(y.a,{readOnly:!0,placeholder:"",renderElement:this.renderElement,renderLeaf:this.renderLeaf,onDOMBeforeInput:function(){},onKeyDown:function(){}}))))))}}]),n}(r.Component)),H=L,T=function(e){Object(m.a)(n,e);var t=Object(O.a)(n);function n(e){var s;return Object(j.a)(this,n),s=t.call(this,e),k.a.initSettings(),s}return Object(b.a)(n,[{key:"render",value:function(){var e=this.props,t=e.currentContent;return e.lastContent?o.a.createElement(H,this.props):o.a.createElement(g,{document:t})}}]),n}(r.Component),_=n(8),R=n(1),A=n(20),F=(n(1724),n(0)),P=function(e){Object(a.a)(n,e);var t=Object(c.a)(n);function n(){var e;Object(s.a)(this,n);for(var i=arguments.length,a=new Array(i),c=0;c<i;c++)a[c]=arguments[c];return(e=t.call.apply(t,[this].concat(a))).onBackClick=function(e){e.preventDefault(),window.history.back()},e}return Object(i.a)(n,[{key:"render",value:function(){return Object(F.jsx)("div",{className:"go-back",onClick:this.onBackClick,children:Object(F.jsx)("span",{className:"fas fa-chevron-left"})})}}]),n}(r.Component),U=P,B=n(50),Y=n(13),K=n.n(Y);K.a.locale(window.app.config.lang);var z=function e(t){Object(s.a)(this,e),this.commitId=t.commit_id||void 0,this.ctime=t.ctime?K()(t.ctime).format("YYYY-MM-DD HH:mm"):"",this.creatorName=t.creator_name||"",this.size=t.size||0,this.revRenamedOldPath=t.rev_renamed_old_path||"",this.revFileId=t.rev_file_id||"",this.path=t.path||"",this.description=t.description||""},q=n(5),G=n(113),J=n(10),$=n(337),Q=n(340),W=n(339),X=n(205),Z=n(115),ee=(n(572),function(e){Object(a.a)(n,e);var t=Object(c.a)(n);function n(e){var i;return Object(s.a)(this,n),(i=t.call(this,e)).onMouseEnter=function(){var e=i.props,t=e.currentVersion,n=e.historyVersion;t.commitId!==n.commitId&&i.setState({isShowOperationIcon:!0})},i.onMouseLeave=function(){var e=i.props,t=e.currentVersion,n=e.historyVersion;t.commitId!==n.commitId&&i.setState({isShowOperationIcon:!1})},i.onToggleClick=function(e){i.setState({isMenuShow:!i.state.isMenuShow})},i.onClick=function(){i.setState({isShowOperationIcon:!1});var e=i.props,t=e.currentVersion,n=e.historyVersion;t.commitId!==n.commitId&&i.props.onSelectHistoryVersion(n)},i.onRestore=function(){var e=i.props.historyVersion;i.props.onRestore(e)},i.onItemDownload=function(){},i.state={isShowOperationIcon:!1,isMenuShow:!1},i}return Object(i.a)(n,[{key:"render",value:function(){var e=this.props,t=e.currentVersion,n=e.historyVersion;if(!t||!n)return null;var s=n.ctime,i=n.commitId,a=n.creatorName,c=n.revFileId,r=i===t.commitId,o=Z.a.getUrl({type:"download_historic_file",filePath:R.pb,objID:c});return Object(F.jsxs)("li",{className:"history-list-item ".concat(r?"item-active":""),onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,onClick:this.onClick,children:[Object(F.jsxs)("div",{className:"history-info",children:[Object(F.jsx)("div",{className:"time",children:s}),Object(F.jsxs)("div",{className:"owner",children:[Object(F.jsx)("span",{className:"squire-icon"}),Object(F.jsx)("span",{children:a})]})]}),Object(F.jsx)("div",{className:"history-operation",children:Object(F.jsxs)($.a,{isOpen:this.state.isMenuShow,toggle:this.onToggleClick,children:[Object(F.jsx)(Q.a,{tag:"a",className:"fas fa-ellipsis-v ".concat(this.state.isShowOperationIcon||r?"":"invisible"),"data-toggle":"dropdown","aria-expanded":this.state.isMenuShow,alt:Object(R.tb)("More Operations")}),Object(F.jsxs)(W.a,{children:[0!==this.props.index&&Object(F.jsx)(X.a,{onClick:this.onItemRestore,children:Object(R.tb)("Restore")}),Object(F.jsx)(X.a,{tag:"a",href:o,onClick:this.onItemDownLoad,children:Object(R.tb)("Download")})]})]})})]})}}]),n}(o.a.Component));n(1725);var te=function(e){var t=e.onChange,n=e.checked,s=e.placeholder,i=e.disabled,a=e.className,c=e.size;return Object(F.jsx)("div",{className:f()("seahub-switch position-relative",a,c),children:Object(F.jsxs)("label",{className:"custom-switch",children:[Object(F.jsx)("input",{className:"custom-switch-input",type:"checkbox",checked:n,onChange:t,name:"custom-switch-checkbox",disabled:i}),Object(F.jsx)("span",{className:"custom-switch-description text-truncate",children:s}),Object(F.jsx)("span",{className:"custom-switch-indicator"})]})})},ne=function(e){Object(a.a)(n,e);var t=Object(c.a)(n);function n(e){var i;return Object(s.a)(this,n),(i=t.call(this,e)).init=function(){i.hasMore=!0,i.nextCommit="",i.filePath="",i.oldFilePath=""},i.listHistoryVersions=function(e,t,n,s){_.a.listOldFileHistoryRecords(e,t,n).then((function(e){var t=e.data;t?i.updateHistoryVersions(t,s):i.setState({isLoading:!1,errorMessage:"There is an error in server."})})).catch((function(e){var t=q.a.getErrorMsg(e,!0);i.setState({isLoading:!1,errorMessage:t})}))},i.onScrollHandler=function(e){var t=e.target.clientHeight,n=e.target.scrollHeight;t+e.target.scrollTop+1>=n&&i.hasMore&&i.nextCommit&&i.loadMore()},i.loadMore=function(){i.state.isLoading||i.setState({isLoading:!0},(function(){var e=i.oldFilePath||i.filePath;i.listHistoryVersions(R.xb,e,i.nextCommit)}))},i.restoreVersion=function(e){var t=e.commitId,n=e.path;G.a.revertFile(n,t).then((function(e){e.data.success&&(i.init(),i.setState({isLoading:!0,historyVersions:[],errorMessage:""},(function(){i.listHistoryVersions(R.xb,R.pb)})))})).catch((function(e){var t=q.a.getErrorMsg(e,!0);J.a.danger(Object(R.tb)(t))}))},i.onSelectHistoryVersion=function(e){if(i.props.isShowChanges){var t=i.state.historyVersions,n=t.findIndex((function(t){return t.commitId===e.commitId}));i.props.onSelectHistoryVersion(e,t[n+1])}else i.props.onSelectHistoryVersion(e)},i.renderHistoryVersions=function(){var e=i.state,t=e.isLoading,n=e.historyVersions,s=e.errorMessage;return 0===n.length?t?Object(F.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center",children:Object(F.jsx)(A.a,{})}):s?Object(F.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center error-message",children:Object(R.tb)(s)}):Object(F.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center empty-tip-color",children:Object(R.tb)("No_historical_versions")}):Object(F.jsxs)(F.Fragment,{children:[n.map((function(e,t){return Object(F.jsx)(ee,{index:t,currentVersion:i.props.currentVersion,historyVersion:e,onSelectHistoryVersion:i.onSelectHistoryVersion,onRestore:i.restoreVersion},e.commitId)})),t&&Object(F.jsx)("div",{className:"loading-more d-flex align-items-center justify-content-center w-100",children:Object(F.jsx)(A.a,{})})]})},i.onShowChanges=function(){var e=i.props.isShowChanges;i.props.onShowChanges(!e)},i.state={isLoading:!0,historyVersions:[],errorMessage:""},i.init(),i}return Object(i.a)(n,[{key:"componentDidMount",value:function(){var e=this;this.listHistoryVersions(R.xb,R.pb,this.nextCommit,(function(t,n){e.props.onSelectHistoryVersion(t,n)}))}},{key:"updateHistoryVersions",value:function(e,t){var n=e.data?e.data.length:0;if(this.nextCommit=e.next_start_commit||"",n){var s=e.data.map((function(e){return new z(e)}));this.filePath=s[n-1].path,this.oldFilePath=s[n-1].revRenamedOldPath;var i=[].concat(Object(B.a)(this.state.historyVersions),Object(B.a)(s));this.setState({historyVersions:i,isLoading:!1,errorMessage:""},(function(){t&&t(i[0],i[1])}))}else this.nextCommit?this.listHistoryVersions(R.xb,R.pb,this.nextCommit):(this.hasMore=!1,this.setState({isLoading:!1,errorMessage:""}))}},{key:"render",value:function(){var e=this.state.historyVersions;return Object(F.jsxs)("div",{className:"sdoc-file-history-panel h-100 o-hidden d-flex flex-column",children:[Object(F.jsx)("div",{className:"sdoc-file-history-select-range",children:Object(F.jsx)("div",{className:"sdoc-file-history-select-range-title",children:Object(R.tb)("History Versions")})}),Object(F.jsx)("div",{className:f()("sdoc-file-history-versions",{"o-hidden":0===e.length}),onScroll:this.onScrollHandler,children:this.renderHistoryVersions()}),Object(F.jsx)("div",{className:"sdoc-file-history-diff-switch d-flex align-items-center",children:Object(F.jsx)(te,{checked:this.props.isShowChanges,placeholder:Object(R.tb)("Show changes"),className:"sdoc-history-show-changes w-100",size:"small",onChange:this.onShowChanges})})]})}}]),n}(r.Component),se=(n(209),n(1726),window.app.config),ie=se.serviceURL,ae=se.avatarURL,ce=se.siteRoot,re=window.app.pageOptions,oe=re.username,le=re.name,de=window.fileHistory.pageOptions,he=de.repoID,ue=de.fileName,fe=de.filePath,je=de.docUuid,be=de.assetsUrl;window.seafile={repoID:he,docPath:fe,docName:ue,docUuid:je,isOpenSocket:!1,serviceUrl:ie,name:le,username:oe,avatarURL:ae,siteRoot:ce,assetsUrl:be};var me=function(e){Object(a.a)(n,e);var t=Object(c.a)(n);function n(e){var i;Object(s.a)(this,n),(i=t.call(this,e)).onSelectHistoryVersion=function(e,t){i.setState({isLoading:!0,currentVersion:e}),_.a.getFileRevision(R.xb,e.commitId,e.path).then((function(e){return _.a.getFileContent(e.data)})).then((function(e){var n=e.data;t?_.a.getFileRevision(R.xb,t.commitId,t.path).then((function(e){return _.a.getFileContent(e.data)})).then((function(e){var t=e.data;i.setContent(n,t)})).catch((function(e){var t=q.a.getErrorMsg(e,!0);J.a.danger(Object(R.tb)(t)),i.setContent(n,"")})):i.setContent(n,"")})).catch((function(e){var t=q.a.getErrorMsg(e,!0);J.a.danger(Object(R.tb)(t)),i.setContent("","")}))},i.setContent=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";i.setState({currentVersionContent:e,lastVersionContent:t,isLoading:!1,changes:[],currentDiffIndex:0})},i.onShowChanges=function(e){i.setState({isShowChanges:e},(function(){localStorage.setItem("seahub-sdoc-history-show-changes",e+"")}))},i.setDiffCount=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{value:[],changes:[]},t=e.changes;i.setState({changes:t,currentDiffIndex:0})},i.jumpToElement=function(e){i.setState({currentDiffIndex:e},(function(){var e=i.state,t=e.currentDiffIndex,n=e.changes[t],s=document.querySelectorAll("[data-id=".concat(n,"]"))[0];s&&(i.historyContentRef.scrollTop=s.offsetTop-10)}))},i.lastChange=function(){var e=i.state,t=e.currentDiffIndex,n=e.changes;0!==t?i.jumpToElement(t-1):i.jumpToElement(n.length-1)},i.nextChange=function(){var e=i.state,t=e.currentDiffIndex;t!==e.changes.length-1?i.jumpToElement(t+1):i.jumpToElement(0)};var a="false"!==localStorage.getItem("seahub-sdoc-history-show-changes");return i.state={isLoading:!0,isShowChanges:a,currentVersion:{},currentVersionContent:"",lastVersionContent:"",changes:[],currentDiffIndex:0},i}return Object(i.a)(n,[{key:"render",value:function(){var e=this,t=this.state,n=t.currentVersion,s=t.isShowChanges,i=t.currentVersionContent,a=t.lastVersionContent,c=t.isLoading,r=t.changes,o=t.currentDiffIndex,l=r?r.length:0,d=s&&l>0;return Object(F.jsxs)("div",{className:"sdoc-file-history d-flex h-100 w-100 o-hidden",children:[Object(F.jsxs)("div",{className:"sdoc-file-history-container d-flex flex-column",children:[Object(F.jsxs)("div",{className:"sdoc-file-history-header pt-2 pb-2 pl-4 pr-4 d-flex justify-content-between w-100 o-hidden",children:[Object(F.jsxs)("div",{className:f()("sdoc-file-history-header-left d-flex align-items-center o-hidden",{"pr-4":d}),children:[Object(F.jsx)(U,{}),Object(F.jsx)("div",{className:"file-name text-truncate",children:ue})]}),d&&Object(F.jsx)("div",{className:"sdoc-file-history-header-right d-flex align-items-center",children:Object(F.jsxs)("div",{className:"sdoc-file-changes-container d-flex align-items-center ",children:[Object(F.jsx)("div",{className:"sdoc-file-changes-tip d-flex align-items-center justify-content-center pl-2 pr-2",children:"".concat(Object(R.tb)("Changes")," ").concat(o+1,"/").concat(l)}),Object(F.jsx)("div",{className:"sdoc-file-changes-divider"}),Object(F.jsx)("div",{className:"sdoc-file-changes-last d-flex align-items-center justify-content-center",id:"sdoc-file-changes-last",onClick:this.lastChange,children:Object(F.jsx)("span",{className:"fas fa-chevron-up"})}),Object(F.jsx)("div",{className:"sdoc-file-changes-divider"}),Object(F.jsx)("div",{className:"sdoc-file-changes-next d-flex align-items-center justify-content-center",id:"sdoc-file-changes-next",onClick:this.nextChange,children:Object(F.jsx)("span",{className:"fas fa-chevron-down"})}),Object(F.jsx)(h.a,{placement:"bottom",target:"sdoc-file-changes-last",children:Object(R.tb)("Last modification")}),Object(F.jsx)(h.a,{placement:"bottom",target:"sdoc-file-changes-next",children:Object(R.tb)("Next modification")})]})})]}),Object(F.jsx)("div",{className:"sdoc-file-history-content f-flex flex-column",ref:function(t){return e.historyContentRef=t},children:c?Object(F.jsx)("div",{className:"sdoc-file-history-viewer d-flex align-items-center justify-content-center",children:Object(F.jsx)(A.a,{})}):Object(F.jsx)(T,{ref:function(t){return e.diffViewerRef=t},currentContent:i,lastContent:s?a:"",didMountCallback:this.setDiffCount})})]}),Object(F.jsx)(ne,{isShowChanges:s,currentVersion:n,onSelectHistoryVersion:this.onSelectHistoryVersion,onShowChanges:this.onShowChanges})]})}}]),n}(o.a.Component);d.a.render(Object(F.jsx)(me,{}),document.getElementById("wrapper"))},572:function(e,t,n){}},[[1703,1,0]]]);
//# sourceMappingURL=sdocFileHistory.chunk.js.map