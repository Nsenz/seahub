(this["webpackJsonpseahub-frontend"]=this["webpackJsonpseahub-frontend"]||[]).push([[17],{1649:function(e,t,n){n(74),e.exports=n(1937)},174:function(e,t,n){"use strict";var s=n(3),i=n(5),a=n(6),o=n(7),r=n(1),c=n.n(r),l=n(2),h=n(10),d=n(0),u=function(e){Object(a.a)(n,e);var t=Object(o.a)(n);function n(e){var i;return Object(s.a)(this,n),(i=t.call(this,e)).onChange=function(e){i.setState({name:e.target.value})},i.onClick=function(e){e.nativeEvent.stopImmediatePropagation()},i.onKeyPress=function(e){"Enter"===e.key&&i.onRenameConfirm(e)},i.onRenameConfirm=function(e){e.nativeEvent.stopImmediatePropagation();var t=i.state.name.trim();if(t!==i.props.name){var n=i.validateInput(),s=n.isValid,a=n.errMessage;s?i.props.onRenameConfirm(t):h.a.danger(a)}else i.props.onRenameCancel()},i.onRenameCancel=function(e){e.nativeEvent.stopImmediatePropagation(),i.props.onRenameCancel()},i.validateInput=function(){var e=i.state.name.trim(),t=!0,n="";return e?e.indexOf("/")>-1?{isValid:t=!1,errMessage:n=Object(l.tb)("Name should not include '/'.")}:{isValid:t,errMessage:n}:{isValid:t=!1,errMessage:n=Object(l.tb)("Name is required.")}},i.state={name:e.name},i}return Object(i.a)(n,[{key:"componentDidMount",value:function(){if(this.refs.renameInput.focus(),this.props.hasSuffix){var e=this.props.name.lastIndexOf(".");this.refs.renameInput.setSelectionRange(0,e,"forward")}else this.refs.renameInput.setSelectionRange(0,-1)}},{key:"render",value:function(){return Object(d.jsxs)("div",{className:"rename-container",children:[Object(d.jsx)("input",{ref:"renameInput",value:this.state.name,onChange:this.onChange,onKeyPress:this.onKeyPress,onClick:this.onClick}),Object(d.jsx)("button",{className:"btn btn-secondary sf2-icon-confirm confirm",onClick:this.onRenameConfirm}),Object(d.jsx)("button",{className:"btn btn-secondary sf2-icon-cancel cancel",onClick:this.onRenameCancel})]})}}]),n}(c.a.Component);t.a=u},1824:function(e,t,n){},1825:function(e,t,n){},1937:function(e,t,n){"use strict";n.r(t);var s=n(3),i=n(5),a=n(6),o=n(7),r=n(1),c=n.n(r),l=n(36),h=n.n(l),d=n(1955),u=n(26),f=n.n(u),m=n(135),j=n(8),g=n(2),p=n(21),b=n(365),v=n(50),O=n(4),x=n(111),y=n(10),C=n(12),S=n.n(C),w=n(316),V=n(319),N=n(318),R=n(203),k=n(115),M=n(174),I=(n(554),n(0));S.a.locale(window.app.config.lang);var H=function(e){Object(a.a)(n,e);var t=Object(o.a)(n);function n(e){var i;return Object(s.a)(this,n),(i=t.call(this,e)).onMouseEnter=function(){var e=i.props,t=e.currentVersion,n=e.historyVersion;t.commit_id!==n.commit_id&&i.setState({isShowOperationIcon:!0})},i.onMouseLeave=function(){var e=i.props,t=e.currentVersion,n=e.historyVersion;t.commit_id!==n.commit_id&&i.setState({isShowOperationIcon:!1})},i.onToggleClick=function(e){i.setState({isMenuShow:!i.state.isMenuShow})},i.onClick=function(){i.setState({isShowOperationIcon:!1});var e=i.props,t=e.currentVersion,n=e.historyVersion;t.commit_id!==n.commit_id&&i.props.onSelectHistoryVersion(n)},i.onRestore=function(){var e=i.props.historyVersion;i.props.onRestore(e)},i.onItemDownload=function(){},i.onItemCopy=function(){var e=i.props.historyVersion;e.ctime_format=S()(e.ctime).format("YYYY-MM-DD HH:mm"),i.props.onCopy(e)},i.toggleRename=function(){i.setState({isRenameShow:!i.state.isRenameShow})},i.onRenameConfirm=function(e){var t=i.props.historyVersion.obj_id;i.props.renameHistoryVersion(t,e),i.toggleRename()},i.onRenameCancel=function(){i.toggleRename()},i.state={isShowOperationIcon:!1,isMenuShow:!1,isRenameShow:!1},i}return Object(i.a)(n,[{key:"render",value:function(){var e=this.props,t=e.currentVersion,n=e.historyVersion;if(!t||!n)return null;var s=n.ctime,i=n.commit_id,a=n.creator_name,o=n.obj_id,r=n.name,c=i===t.commit_id,l=k.a.getUrl({type:"download_historic_file",filePath:g.pb,objID:o});return Object(I.jsxs)("li",{className:"history-list-item ".concat(c?"item-active":""),onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,onClick:this.onClick,children:[Object(I.jsxs)("div",{className:"history-info",children:[this.state.isRenameShow?Object(I.jsx)(M.a,{name:r,onRenameConfirm:this.onRenameConfirm,onRenameCancel:this.onRenameCancel}):Object(I.jsx)("div",{className:"name",children:r}),Object(I.jsx)("div",{className:"time",children:S()(s).format("YYYY-MM-DD HH:mm")}),Object(I.jsxs)("div",{className:"owner",children:[Object(I.jsx)("span",{className:"squire-icon"}),Object(I.jsx)("span",{children:a})]})]}),Object(I.jsx)("div",{className:"history-operation",children:Object(I.jsxs)(w.a,{isOpen:this.state.isMenuShow,toggle:this.onToggleClick,children:[Object(I.jsx)(V.a,{tag:"a",className:"fas fa-ellipsis-v ".concat(this.state.isShowOperationIcon||c?"":"invisible"),"data-toggle":"dropdown","aria-expanded":this.state.isMenuShow,alt:Object(g.tb)("More Operations")}),Object(I.jsxs)(N.a,{children:[Object(I.jsx)(R.a,{tag:"a",href:l,onClick:this.onItemDownLoad,children:Object(g.tb)("Download")}),0!==this.props.index&&Object(I.jsx)(R.a,{onClick:this.onItemCopy,children:Object(g.tb)("Copy")}),Object(I.jsx)(R.a,{onClick:this.toggleRename,children:Object(g.tb)("Rename")})]})]})})]})}}]),n}(c.a.Component);n(1824);var _=function(e){var t=e.onChange,n=e.checked,s=e.placeholder,i=e.disabled,a=e.className,o=e.size;return Object(I.jsx)("div",{className:f()("seahub-switch position-relative",a,o),children:Object(I.jsxs)("label",{className:"custom-switch",children:[Object(I.jsx)("input",{className:"custom-switch-input",type:"checkbox",checked:n,onChange:t,name:"custom-switch-checkbox",disabled:i}),Object(I.jsx)("span",{className:"custom-switch-description text-truncate",children:s}),Object(I.jsx)("span",{className:"custom-switch-indicator"})]})})},D=window.fileHistory.pageOptions.docUuid,L=function(e){Object(a.a)(n,e);var t=Object(o.a)(n);function n(e){var i;return Object(s.a)(this,n),(i=t.call(this,e)).loadMore=function(){if(!i.state.isReloadingData){var e=i.state.currentPage+1;i.setState({currentPage:e,isReloadingData:!0}),j.a.listSdocHistory(D,e,g.a).then((function(e){i.updateResultState(e.data),i.setState({isReloadingData:!1})}))}},i.renameHistoryVersion=function(e,t){j.a.renameSdocHistory(D,e,t).then((function(n){i.setState({historyVersions:i.state.historyVersions.map((function(n){return n.obj_id==e&&(n.name=t),n}))})})).catch((function(e){var t=O.a.getErrorMsg(e,!0);i.setState({isLoading:!1,errorMessage:t})}))},i.onScrollHandler=function(e){var t=e.target.clientHeight,n=e.target.scrollHeight;t+e.target.scrollTop+1>=n&&i.state.hasMore&&i.loadMore()},i.restoreVersion=function(e){var t=e.commit_id,n=e.path;x.a.revertFile(n,t).then((function(e){e.data.success&&(i.setState({isLoading:!0}),i.refershFileList());var t=Object(g.tb)("Successfully restored.");y.a.success(t)})).catch((function(e){var t=O.a.getErrorMsg(e,!0);y.a.danger(Object(g.tb)(t))}))},i.onSelectHistoryVersion=function(e){if(i.props.isShowChanges){var t=i.state.historyVersions,n=t.findIndex((function(t){return t.commit_id===e.commit_id}));i.props.onSelectHistoryVersion(e,t[n+1])}else i.props.onSelectHistoryVersion(e)},i.copyHistoryFile=function(e){var t=e.path,n=e.obj_id,s=e.ctime_format;j.a.sdocCopyHistoryFile(g.xb,t,n,s).then((function(e){var t=Object(g.tb)("Successfully copied %(name)s."),n=e.data.file_name;t=t.replace("%(name)s",n),y.a.success(t)})).catch((function(e){var t=O.a.getErrorMsg(e,!0);y.a.danger(Object(g.tb)(t))}))},i.renderHistoryVersions=function(){var e=i.state,t=e.isLoading,n=e.historyVersions,s=e.errorMessage;return 0===n.length?t?Object(I.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center",children:Object(I.jsx)(p.a,{})}):s?Object(I.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center error-message",children:Object(g.tb)(s)}):Object(I.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center empty-tip-color",children:Object(g.tb)("No_historical_versions")}):Object(I.jsxs)(I.Fragment,{children:[n.map((function(e,t){return Object(I.jsx)(H,{index:t,currentVersion:i.props.currentVersion,historyVersion:e,onSelectHistoryVersion:i.onSelectHistoryVersion,onRestore:i.restoreVersion,onCopy:i.copyHistoryFile,renameHistoryVersion:i.renameHistoryVersion},e.commit_id)})),t&&Object(I.jsx)("div",{className:"loading-more d-flex align-items-center justify-content-center w-100",children:Object(I.jsx)(p.a,{})})]})},i.onShowChanges=function(){var e=i.props,t=e.isShowChanges,n=e.currentVersion,s=i.state.historyVersions,a=s.findIndex((function(e){return e.commit_id===n.commit_id})),o=s[a+1];i.props.onShowChanges(!t,o)},i.state={isLoading:!0,historyVersions:[],errorMessage:"",currentPage:1,hasMore:!1,fileOwner:"",isReloadingData:!1},i}return Object(i.a)(n,[{key:"componentDidMount",value:function(){var e=this;j.a.listSdocHistory(D,1,g.a).then((function(t){if(0===t.data.length)throw e.setState({isLoading:!1}),Error("there has an error in server");e.initResultState(t.data)}))}},{key:"refershFileList",value:function(){var e=this;j.a.listSdocHistory(D,1,g.a).then((function(t){e.initResultState(t.data)}))}},{key:"initResultState",value:function(e){e.histories.length&&(this.setState({historyVersions:e.histories,currentPage:e.page,hasMore:e.total_count>g.a*this.state.currentPage,isLoading:!1,fileOwner:e.histories[0].creator_email}),this.props.onSelectHistoryVersion(e.histories[0],e.histories[1]))}},{key:"updateResultState",value:function(e){e.histories.length&&this.setState({historyVersions:[].concat(Object(v.a)(this.state.historyVersions),Object(v.a)(e.histories)),currentPage:e.page,hasMore:e.total_count>g.a*this.state.currentPage,isLoading:!1,fileOwner:e.histories[0].creator_email})}},{key:"render",value:function(){var e=this.state.historyVersions;return Object(I.jsxs)("div",{className:"sdoc-file-history-panel h-100 o-hidden d-flex flex-column",children:[Object(I.jsx)("div",{className:"sdoc-file-history-select-range",children:Object(I.jsx)("div",{className:"sdoc-file-history-select-range-title",children:Object(g.tb)("History Versions")})}),Object(I.jsx)("div",{className:f()("sdoc-file-history-versions",{"o-hidden":0===e.length}),onScroll:this.onScrollHandler,children:this.renderHistoryVersions()}),Object(I.jsx)("div",{className:"sdoc-file-history-diff-switch d-flex align-items-center",children:Object(I.jsx)(_,{checked:this.props.isShowChanges,placeholder:Object(g.tb)("Show changes"),className:"sdoc-history-show-changes w-100",size:"small",onChange:this.onShowChanges})})]})}}]),n}(r.Component),E=(n(190),n(1825),window.app.config),P=E.serviceURL,F=E.avatarURL,T=E.siteRoot,U=window.app.pageOptions,Y=U.username,q=U.name,B=window.fileHistory.pageOptions,K=B.repoID,z=B.fileName,A=B.filePath,J=B.docUuid,G=B.assetsUrl;window.seafile={repoID:K,docPath:A,docName:z,docUuid:J,isOpenSocket:!1,serviceUrl:P,name:q,username:Y,avatarURL:F,siteRoot:T,assetsUrl:G};var Q=function(e){Object(a.a)(n,e);var t=Object(o.a)(n);function n(e){var i;Object(s.a)(this,n),(i=t.call(this,e)).onSelectHistoryVersion=function(e,t){i.setState({isLoading:!0,currentVersion:e}),j.a.getFileRevision(g.xb,e.commit_id,e.path).then((function(e){return j.a.getFileContent(e.data)})).then((function(e){var n=e.data;t?j.a.getFileRevision(g.xb,t.commit_id,t.path).then((function(e){return j.a.getFileContent(e.data)})).then((function(e){var t=e.data;i.setContent(n,t)})).catch((function(e){var t=O.a.getErrorMsg(e,!0);y.a.danger(Object(g.tb)(t)),i.setContent(n,"")})):i.setContent(n,"")})).catch((function(e){var t=O.a.getErrorMsg(e,!0);y.a.danger(Object(g.tb)(t)),i.setContent("","")}))},i.setContent=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";i.setState({currentVersionContent:e,lastVersionContent:t,isLoading:!1,changes:[],currentDiffIndex:0})},i.onShowChanges=function(e,t){if(e&&t){var n=i.state.currentVersionContent;i.setState({isLoading:!0},(function(){localStorage.setItem("seahub-sdoc-history-show-changes",e+""),j.a.getFileRevision(g.xb,t.commit_id,t.path).then((function(e){return j.a.getFileContent(e.data)})).then((function(t){var s=t.data;i.setContent(n,s),i.setState({isShowChanges:e})})).catch((function(t){var s=O.a.getErrorMsg(t,!0);y.a.danger(Object(g.tb)(s)),i.setContent(n,""),i.setState({isShowChanges:e})}))}))}else i.setState({isShowChanges:e},(function(){localStorage.setItem("seahub-sdoc-history-show-changes",e+"")}))},i.setDiffCount=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{value:[],changes:[]},t=e.changes;i.setState({changes:t,currentDiffIndex:0})},i.jumpToElement=function(e){i.setState({currentDiffIndex:e},(function(){var e=i.state,t=e.currentDiffIndex,n=e.changes[t],s=document.querySelectorAll("[data-id=".concat(n,"]"))[0];s&&(i.historyContentRef.scrollTop=s.offsetTop-10)}))},i.lastChange=function(){var e=i.state,t=e.currentDiffIndex,n=e.changes;0!==t?i.jumpToElement(t-1):i.jumpToElement(n.length-1)},i.nextChange=function(){var e=i.state,t=e.currentDiffIndex;t!==e.changes.length-1?i.jumpToElement(t+1):i.jumpToElement(0)},i.renderChangesTip=function(){var e=i.state,t=e.isShowChanges,n=e.changes,s=e.currentDiffIndex;if(e.isLoading)return null;if(!t)return null;var a=n?n.length:0;return 0===a?Object(I.jsx)("div",{className:"sdoc-file-history-header-right d-flex align-items-center",children:Object(I.jsx)("div",{className:"sdoc-file-changes-container d-flex align-items-center pl-2 pr-2",children:Object(g.tb)("No changes")})}):Object(I.jsx)("div",{className:"sdoc-file-history-header-right d-flex align-items-center",children:Object(I.jsxs)("div",{className:"sdoc-file-changes-container d-flex align-items-center",children:[Object(I.jsx)("div",{className:"sdoc-file-changes-tip d-flex align-items-center justify-content-center pl-2 pr-2",children:"".concat(Object(g.tb)("Changes")," ").concat(s+1,"/").concat(a)}),Object(I.jsx)("div",{className:"sdoc-file-changes-divider"}),Object(I.jsx)("div",{className:"sdoc-file-changes-last d-flex align-items-center justify-content-center",id:"sdoc-file-changes-last",onClick:i.lastChange,children:Object(I.jsx)("span",{className:"fas fa-chevron-up"})}),Object(I.jsx)("div",{className:"sdoc-file-changes-divider"}),Object(I.jsx)("div",{className:"sdoc-file-changes-next d-flex align-items-center justify-content-center",id:"sdoc-file-changes-next",onClick:i.nextChange,children:Object(I.jsx)("span",{className:"fas fa-chevron-down"})}),Object(I.jsx)(d.a,{placement:"bottom",target:"sdoc-file-changes-last",children:Object(g.tb)("Last modification")}),Object(I.jsx)(d.a,{placement:"bottom",target:"sdoc-file-changes-next",children:Object(g.tb)("Next modification")})]})})};var a="false"!==localStorage.getItem("seahub-sdoc-history-show-changes");return i.state={isLoading:!0,isShowChanges:a,currentVersion:{},currentVersionContent:"",lastVersionContent:"",changes:[],currentDiffIndex:0},i}return Object(i.a)(n,[{key:"render",value:function(){var e=this,t=this.state,n=t.currentVersion,s=t.isShowChanges,i=t.currentVersionContent,a=t.lastVersionContent,o=t.isLoading;return Object(I.jsxs)("div",{className:"sdoc-file-history d-flex h-100 w-100 o-hidden",children:[Object(I.jsxs)("div",{className:"sdoc-file-history-container d-flex flex-column",children:[Object(I.jsxs)("div",{className:"sdoc-file-history-header pt-2 pb-2 pl-4 pr-4 d-flex justify-content-between w-100 o-hidden",children:[Object(I.jsxs)("div",{className:f()("sdoc-file-history-header-left d-flex align-items-center o-hidden",{"pr-4":s}),children:[Object(I.jsx)(b.a,{}),Object(I.jsx)("div",{className:"file-name text-truncate",children:z})]}),this.renderChangesTip()]}),Object(I.jsx)("div",{className:"sdoc-file-history-content f-flex flex-column",ref:function(t){return e.historyContentRef=t},children:o?Object(I.jsx)("div",{className:"sdoc-file-history-viewer d-flex align-items-center justify-content-center",children:Object(I.jsx)(p.a,{})}):Object(I.jsx)(m.a,{currentContent:i,lastContent:s?a:"",didMountCallback:this.setDiffCount})})]}),Object(I.jsx)(L,{isShowChanges:s,currentVersion:n,onSelectHistoryVersion:this.onSelectHistoryVersion,onShowChanges:this.onShowChanges})]})}}]),n}(c.a.Component);h.a.render(Object(I.jsx)(Q,{}),document.getElementById("wrapper"))},365:function(e,t,n){"use strict";var s=n(3),i=n(5),a=n(6),o=n(7),r=n(1),c=(n(574),n(0)),l=function(e){Object(a.a)(n,e);var t=Object(o.a)(n);function n(){var e;Object(s.a)(this,n);for(var i=arguments.length,a=new Array(i),o=0;o<i;o++)a[o]=arguments[o];return(e=t.call.apply(t,[this].concat(a))).onBackClick=function(e){e.preventDefault(),window.history.back()},e}return Object(i.a)(n,[{key:"render",value:function(){return Object(c.jsx)("div",{className:"go-back",onClick:this.onBackClick,children:Object(c.jsx)("span",{className:"fas fa-chevron-left"})})}}]),n}(r.Component);t.a=l},554:function(e,t,n){},574:function(e,t,n){}},[[1649,1,0]]]);
//# sourceMappingURL=sdocFileHistory.chunk.js.map